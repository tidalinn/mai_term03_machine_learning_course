# ML System Design Doc - Система определения кухни по названию блюда с рекомендацией ресторанов

>## Термины и определения
>
>* *Сервис* - система, определяющая вид кухни по названию блюда и предоставляющая координаты ресторанов, где подают блюда этой кухни.
>* *Запрос* - название блюда на английском языке.
>* *Пользователь* - физическое лицо, которое направляет запрос в сервис.

<br>

![app-representation](https://github.com/tidalinn/mai_term03_machine_learning_course/blob/main/project_cuisine/gifs/app.gif)


## 1 Цели и предпосылки


### 1.1 Потребность в разработке

* *Бизнес-цель:* создание сервиса, который может сориентировать пользователя по блюжайшим ресторанам, в которых подают блюда из того вида кухни, к которому относится название блюда, которое он помнит, но не знает, как определить рестораны, где готовят блюда того же характера.

* *Польза:* пользователь может не знать название кухни, к которому относится блюдо, но желал бы съесть что-то похожее - сервис рекомендует ему ближайшие рестораны, специализирующиеся на кухне, которую он определил по наименованию блюда.


### 1.2. Бизнес-требования и ограничения

* *Логика работы ML:* в основе принцип запрос-ответ: пользователь пишет название блюда, а сервис выдаёт название кухни и координаты ресторанов в округе, её предоставляющих.
  
* *Бизнес-требования:* запрос-ответ не должен занимать более 10 секунд.

* *Успешная модель:* классифицирующая блюда как можно более точно.

* *Сценарий использования:* 
  * <ins>input:</ins> "ramen chicken don" -> [обработка сервисом запроса -> chinese, ramen, indian] -> список координат ресторанов, которые специализируются на этой кухне.
  
* *Возможные пути развития проекта:* 
  * Ускорение обработки запроса.
  * Распознавание слов с опечатками.
  * Добавление интерактивной карты с добавленными точками ресторанов.
  * Публикация на web-ресурсе.
  * Расширение базы данных - сейчас ограничена только городом Сингапур, а соответственно и специфичными для этого города блюдами. Кроме того, хотелось бы больше информации о ресторанах.
  
* *Среда выполнения:* 
  * localhost: `python app.py`.
  * localhost: `flask run --port 8000`.
  
* *Стэк технологий:* Python, Flask, HTML, CSS, JavaScript.
  
* *Данные:* open source датасет [Delivery Hero Recommendation Dataset](https://dl.acm.org/doi/pdf/10.1145/3604915.3610242) (город: Сингапур).
  
* *Исполнители:* одна человекоединица в лице DataScientist'а.
  

### 1.3 Что входит в scope проекта, что не входит

* *Ожидания от проекта:* 
  * Multi-label classification по названию блюда (одному блюду соответствует несколько видов кухонь).
  * Вывод координат ближайших ресторанов, специализирующихся на этой кухне и входящих в ТОП по частоте заказов.
  
* *Что не будет закрыто:* на данный момент обработка запроса занимает около 30 секунд, что плохо для пользовательского опыта.
  
* *Образ результата (код):* 
  * jupyter-ноутбуки (EDA, ML, демонстрация работы сервиса).
  * localhost-реализация сервиса с интерактивной веб-страницей.

* *Образ результата (сервис):* 
  * Форма с полями:
    * Название блюда.
    * Текущий час (с возможностью изменения значения).
    * Местоположение пользователя (по умолчанию Сингапур, но с возможностью изменения значения).
  * Вывод:
    * Все определённые виды кухни.
    * Виды кухни, на которых специализируются ближайшие рестораны.
    * Геокоординаты (широта, долгота) ближайших ресторанов, специализирующихся на этих видах кухни.
  
* *Планируемый технический долг:* скорость обработки сервиса (сейчас ~30сек вместо max 10сек).


### 1.4 Предпосылки решения

* *Общие предпосылки решения, используемые в системе:*
  * Multi-label classification:
    * Целевой признак: `primary_cuisine`.
    * Признаки: `name`.
  * Рекомендательная система:
    * Таблица, сгруппированная по столбцам `primary_cuisine`, `name`, `time_of_day` (время суток) и отсортированная по возрастанию `distance` (расстояние от пользователя до ресторана).
    * ТОП-5 строк отфильтрованной по каждому виду кухни таблицы.
    * ТОП-5 строк итоговой таблицы, отсортированной по убыванию `count` (частоте заказов блюд).


## 2 Методология


### 2.1 Постановка задач

* *Этап 1:* EDA - `eda_sg.ipynb`.
* *Этап 2:* Multi-label classification - `model_sg.ipynb`.
* *Этап 3:* Рекомендательная система - `recommendation_sg.ipynb`.
* *Этап 4:* Деплой модели - `webapp/`.


### 2.2 Блок-схема решения

Этап | Описание | Задачи
-|-|-
**1** | **Проведение EDA** | 
1.1 | Выбор и сбор данных | Скачивание, загрузка и подготовка данных
1.2 | Предобработка данных | Выявление аномалий, пропусков, дубликатов, проверка правдоподобности, аугментация
1.3 | Анализ данных | Проверка зависимостей признаков от целевой переменной
1.4 | Сохранение витрин данных | Сохранение двух видов витрин данных:</br>1) Multi-label classification</br>2) Рекомендательная система
**2** | **Обучение модели** | 
2.1 | Полдготовка к обучению | Кодирование и обработка данных
2.2 | Обучение | Определение метрик и функции потерь, построение Baseline-модели, подбор модели и параметров, выбор лучшей модели
2.3 | Тестирование | Проверка поведения модели на тестовых данных
2.4 | Экспорт | Экспорт моделей, сохранение функций, обрабатывающих данные
**3** | **Формирование рекомендаций** |
3.1 | Подготовка данных | Формирование набора данных для построения рейтинга
3.2 | Сохранение данных | Сохранение набора данных для построения рейтинга
3.3 | Построение рекомендательной системы | Реализация и сохранение функций, обрабатывающих данные
3.4 | Имитация поведения пользователя | Демонстрация работы классификатора и системы рекомендаций
**4** | **Деплой** |
4.1 | Формирование структуры проекта | Создание папок и файлов
4.2 | Создание HTML-интерфейса | Создание форм приёма и выдачи данных
4.3 | Добавление логики обработки значений | Настройка функций и взаимодействия файлов 
4.4 | Тестирование | Проверка и отладка работоспособности сервиса


### 2.3 Основные аспекты

Этап | Свойство | Значение
-|-|-
1 | **Multi-label classification** |
1.1 | Признаки | `name`
1.2 | Целевой признак | `primary_cuisine`
1.3 | Метрики | `binary_accuracy`
1.4 | Функция потерь | `binary_crossentropy`, `macro_soft_accuracy`
1.5 | Порог | 0.9
1.6 | Baseline | LogisticRegression
1.7 | Модель | FCNN
1.8 | Результаты | 
2 | **Рекомендательная система** |
2.1 | Порог | 1) 5 строк по увеличению расстояния от пользователя до ресторана</br>2) 5 строк по уменьшению количества заказов


## 4 Внедрение


### 4.1 Архитектура решения

```
└── project_cuisine/
  ├── data/
  ├── gifs/
  ├── webapp/
  |  ├── data/
  |  |  └── data_count_rating.csv
  |  ├── funcs/
  |  |  ├── __init__.py
  |  |  └── utils.py                    # функции обработки значений
  |  ├── model/
  |  |  ├── model.h5                    # обученная модель
  |  |  ├── multilabel.pkl              # словарь слов
  |  |  └── vectorizer.pkl              # обученный векторизатор слов
  |  ├── static/ 
  |  |  ├── img/
  |  |  |  └── background.jpg
  |  |  ├── main.css
  |  |  └── main.js
  |  ├── template/ 
  |  |  └── main.html
  |  ├── app.py                         # файл компиляции проекта
  |  └── requirements.txt
  ├── .gitignore.txt
  ├── eda_sg.ipynb                      # EDA
  ├── model_sg.ipynb                    # Multi-label classification
  ├── README.md  
  └── recommendation_sg.ipynb           # рекомендательная система
```


### 4.2 Инфраструктура и масштабируемость

* Автономный сервис.
* Деплой реализован с помощью Flask.
* Стили интерфейса написаны с помощью Tilewind.
* Определение координа пользователя воспроизводится посредством обращения к сервису `nominatim.openstreetmap.org`:
```
https://nominatim.openstreetmap.org/search.php?q={place}&format=jsonv2'
```
* Возможна доработка: добавление новых возможностей и улучшение реализованных.


### 4.3 Требования к работе системы

* Корректная классификация входящих запросов.
* В случае отсутствия искомого запроса сервис должен уведомлять об отсутствии значений среди результатов поиска - `No results`.


### 4.4 Безопасность системы

Сервис безопасен и не предоставляет контент, не имеющий отношение к еде.


### 4.5 Безопасность данных

Сервис напрямую не взаимодействует с пользовательскими данными.